name: Update Iran Proxies

on:
  schedule:
    - cron: '0 */7 * * *'  # Ù‡Ø± 6 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±
  workflow_dispatch:
    inputs:
      manual_trigger:
        description: 'Trigger manually'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install PySocks requests beautifulsoup4 pyyaml lxml
        

    
    - name:  Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªØºÛŒÛŒØ±Ø§Øª
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
        show_status() {
          echo "ğŸ“Š $1"
        }
        
        # ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
        run_update_script() {
          show_status "Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ..."
          python scripts/update.py
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§
          if [ ! -f "output/config.yaml" ]; then
            echo "âŒ ÙØ§ÛŒÙ„ config Ø³Ø§Ø®ØªÙ‡ Ù†Ø´Ø¯!"
            return 1
          fi
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¬Ù… ÙØ§ÛŒÙ„
          file_size=$(wc -c < "output/config.yaml")
          if [ "$file_size" -lt 100 ]; then
            echo "âš ï¸ ÙØ§ÛŒÙ„ config Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© Ø§Ø³Øª ($file_size Ø¨Ø§ÛŒØª)"
            return 1
          fi
          
          echo "âœ… Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯"
          return 0
        }
        
        # ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ commit Ùˆ push
        commit_and_push() {
          show_status "Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§..."
          git add -f output/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "ğŸ¤– Update proxy list - $COMMIT_DATE"
            
            show_status "Ø¢Ù¾Ù„ÙˆØ¯ ØªØºÛŒÛŒØ±Ø§Øª..."
            if git push origin HEAD:main; then
              echo "âœ… Push Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²"
              return 0
            else
              echo "âŒ Push Ù†Ø§Ù…ÙˆÙÙ‚"
              return 1
            fi
          else
            echo "âš ï¸ No changes to commit"
            return 0
          fi
        }
        
        # === Ø±Ø§Ù‡â€ŒØ­Ù„ Û±: Ø±ÙˆØ´ Ù…Ø¹Ù…ÙˆÙ„ÛŒ (Ø§ÙˆÙ„ÛŒÙ† ØªÙ„Ø§Ø´) ===
        show_status "ğŸ”„ Ø±Ø§Ù‡â€ŒØ­Ù„ Û±: Ø±ÙˆØ´ Ù…Ø¹Ù…ÙˆÙ„ÛŒ..."
        git fetch origin
        
        # Ø³Ø¹ÛŒ Ú©Ù† merge Ú©Ù†ÛŒ
        if git merge origin/main --no-ff --no-edit; then
          echo "âœ… Merge Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²"
        else
          echo "âš ï¸ Merge Ø¨Ø§ conflict Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ"
          git merge --abort 2>/dev/null || true
        fi
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
        if run_update_script; then
          if commit_and_push; then
            echo "ğŸ‰ Ø±Ø§Ù‡â€ŒØ­Ù„ Û± Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!"
            exit 0
          fi
        fi
        
        # === Ø±Ø§Ù‡â€ŒØ­Ù„ Û²: rebase (Ø¯ÙˆÙ…ÛŒÙ† ØªÙ„Ø§Ø´) ===
        show_status "ğŸ”„ Ø±Ø§Ù‡â€ŒØ­Ù„ Û²: ØªÙ„Ø§Ø´ Ø¨Ø§ rebase..."
        git fetch origin
        
        # reset Ø¨Ù‡ origin/main
        git reset --hard origin/main 2>/dev/null || true
        
        # Ø§Ø¬Ø±Ø§ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
        if run_update_script; then
          # Ø¨Ø§ --force push Ú©Ù†
          git add -f output/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "ğŸ¤– Update proxy list - $COMMIT_DATE"
            
            if git push origin HEAD:main --force-with-lease; then
              echo "âœ… Ø±Ø§Ù‡â€ŒØ­Ù„ Û² Ø¨Ø§ force Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!"
              exit 0
            fi
          fi
        fi
        
        # === Ø±Ø§Ù‡â€ŒØ­Ù„ Û³: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø³Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯ (Ø¢Ø®Ø±ÛŒÙ† Ø±Ø§Ù‡â€ŒØ­Ù„) ===
        show_status "ğŸ”„ Ø±Ø§Ù‡â€ŒØ­Ù„ Û³: Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø³Ø§Ø®Øª Ø§Ø² Ù†Ùˆ (Ø¢Ø®Ø±ÛŒÙ† Ø±Ø§Ù‡â€ŒØ­Ù„)..."
        
        # Û±. Ú©Ø§Ù…Ù„Ø§Ù‹ Ù¾Ø§Ú© Ú©Ù† Ùˆ Ø§Ø² Ù†Ùˆ Ø¨Ú¯ÛŒØ±
        git fetch origin
        git reset --hard origin/main
        git clean -fd
        
        # Û². Ù¾ÙˆØ´Ù‡ output Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
        rm -rf output/ 2>/dev/null || true
        mkdir -p output/logs
        
        # Û³. Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†
        if run_update_script; then
          # Û´. ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
          git add output/
          
          # Ûµ. commit Ú©Ù†
          COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
          git commit -m "ğŸ¤– Update proxy list - $COMMIT_DATE"
          
          # Û¶. push Ø¨Ø§ force Ù…Ø·Ù„Ù‚
          if git push origin HEAD:main --force; then
            echo "âœ… Ø±Ø§Ù‡â€ŒØ­Ù„ Û³ (Ø¢Ø®Ø±ÛŒÙ† Ø±Ø§Ù‡â€ŒØ­Ù„) Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯!"
            
            # Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯
            if [ -f "output/logs/latest.log" ]; then
              echo "ğŸ“‹ Ø¢Ø®Ø±ÛŒÙ† Ù„Ø§Ú¯:"
              tail -5 output/logs/latest.log
            fi
            exit 0
          else
            echo "âŒ Ø­ØªÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø±Ø§Ù‡â€ŒØ­Ù„ Ù‡Ù… Ø¬ÙˆØ§Ø¨ Ù†Ø¯Ø§Ø¯!"
            exit 1
          fi
        else
          echo "âŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø± Ø¢Ø®Ø±ÛŒÙ† Ø±Ø§Ù‡â€ŒØ­Ù„ Ù‡Ù… Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯!"
          exit 1
        fi
