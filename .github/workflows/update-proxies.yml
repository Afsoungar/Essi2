name: Update Iran Proxies

on:
  schedule:
    - cron: '0 */6 * * *'  # ูุฑ 6 ุณุงุนุช ฺฉุจุงุฑ
  workflow_dispatch:
    inputs:
      manual_trigger:
        description: 'Trigger manually'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  update-proxies:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: ๐ฅ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ๐ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ๐ฆ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install beautifulsoup4 lxml
    
    - name: ๐พ ููุดููุฏ: ูุฏุฑุช ุชุบุฑุงุช ุจุง ฺฉุด ูููุช
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # ูุณุฑ ูุงู ูููุช ุจุฑุง ุฐุฎุฑู ูุชุงุฌ
        TEMP_RESULTS="temp_proxy_results.json"
        TEMP_LOCK="temp_lock.file"
        
        # ุชุงุจุน ุจุฑุง ููุงุด ูุถุนุช
        show_status() {
          echo "๐ $1"
        }
        
        # ุชุงุจุน ุจุฑุง ูพุงฺฉ ฺฉุฑุฏู ูุงูโูุง ูููุช (ุงฺฏุฑ ุงุฒ ุงุฌุฑุง ูุจู ุจุงู ูุงูุฏู)
        cleanup_temp_files() {
          show_status "ูพุงฺฉ ฺฉุฑุฏู ูุงูโูุง ูููุช ูุฏู..."
          rm -f "$TEMP_RESULTS" "$TEMP_LOCK" 2>/dev/null || true
        }
        
        # ุชุงุจุน ุจุฑุง ุงุฌุฑุง ุงุณฺฉุฑูพุช ู ุฐุฎุฑู ูุชุงุฌ ุฏุฑ ูุงู ูููุช
        run_update_and_save() {
          show_status "ุงุฌุฑุง ุงุณฺฉุฑูพุช ุจูโุฑูุฒุฑุณุงู ู ุฐุฎุฑู ูุชุงุฌ..."
          
          # ุงฺฏุฑ ูุงู ูููุช ุงุฒ ูุจู ูุฌูุฏ ุฏุงุฑุฏุ ุงุณุชูุงุฏู ฺฉู
          if [ -f "$TEMP_RESULTS" ] && [ -s "$TEMP_RESULTS" ]; then
            show_status "๐ ุงุณุชูุงุฏู ุงุฒ ูุชุงุฌ ุฐุฎุฑู ุดุฏู ูุจู..."
            
            # ฺฉูพ ูุงู ูููุช ุจู ุฎุฑูุฌ
            mkdir -p output/logs
            if python -c "
import json, yaml, os
with open('$TEMP_RESULTS', 'r') as f:
    data = json.load(f)

# ุณุงุฎุช config ุงุฒ ูุชุงุฌ ุฐุฎุฑู ุดุฏู
config = {'proxies': data['proxies'], 'metadata': data['metadata']}

# ุฐุฎุฑู config
os.makedirs('output', exist_ok=True)
with open('output/config.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

# ุณุงุฎุช ูุงฺฏ
import datetime
log_content = '''ูุชุงุฌ ุงุฒ ฺฉุด ูููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ
ุชุงุฑุฎ: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ุชุนุฏุงุฏ ูพุฑูฺฉุณโูุง: {len(data['proxies'])}
ููุงุจุน ุงุณุชูุงุฏู ุดุฏู: {data['metadata'].get('sources_used', 0)}
ูพุฑูฺฉุณโูุง ุงุฑุงู: {data['metadata'].get('iranian_proxies', 0)}
'''.strip()

os.makedirs('output/logs', exist_ok=True)
with open('output/logs/latest.log', 'w', encoding='utf-8') as f:
    f.write(log_content)

print('โ ูุชุงุฌ ุงุฒ ฺฉุด ุจุงุฑฺฏุฐุงุฑ ุดุฏ')
            "; then
              echo "โ ุงุณุชูุงุฏู ุงุฒ ูุชุงุฌ ฺฉุด ูููู ุจูุฏ"
              return 0
            fi
          fi
          
          # ุงฺฏุฑ ูุชุงุฌ ุฐุฎุฑู ุดุฏู ูุฏุงุฑูุ ุงุฌุฑุง ฺฉู
          show_status "๐ ุงุณุชุฎุฑุงุฌ ูพุฑูฺฉุณโูุง ุงุฒ ููุงุจุน..."
          python scripts/update.py
          
          # ุจุฑุฑุณ ููููุช ุงุฌุฑุง
          if [ ! -f "output/config.yaml" ]; then
            echo "โ ูุงู config ุณุงุฎุชู ูุดุฏ!"
            return 1
          fi
          
          # ุฐุฎุฑู ูุชุงุฌ ุฏุฑ ูุงู ูููุช ุจุฑุง ูุฑุงุญู ุจุนุฏ
          show_status "๐พ ุฐุฎุฑู ูุชุงุฌ ุฏุฑ ูุงู ูููุช..."
          if python -c "
import json, yaml, os, datetime

# ุฎูุงูุฏู config
with open('output/config.yaml', 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)

# ุฐุฎุฑู ุฏุฑ JSON
results = {
    'proxies': config.get('proxies', []),
    'metadata': config.get('metadata', {}),
    'saved_at': datetime.datetime.now().isoformat()
}

with open('$TEMP_RESULTS', 'w', encoding='utf-8') as f:
    json.dump(results, f, indent=2)

print(f'โ ูุชุงุฌ ุฏุฑ ูุงู ูููุช ุฐุฎุฑู ุดุฏ ({len(results[\"proxies\"])} ูพุฑูฺฉุณ)')
          "; then
            echo "โ ูุชุงุฌ ุฐุฎุฑู ุดุฏ"
          fi
          
          return 0
        }
        
        # ุชุงุจุน ุจุฑุง commit ู push
        commit_and_push() {
          show_status "ุงุถุงูู ฺฉุฑุฏู ูุงูโูุง..."
          git add -f output/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "๐ค Update proxy list - $COMMIT_DATE"
            
            show_status "ุขูพููุฏ ุชุบุฑุงุช..."
            if git push origin HEAD:main; then
              echo "โ Push ููููุชโุขูุฒ"
              return 0
            else
              echo "โ Push ูุงูููู"
              return 1
            fi
          else
            echo "โ๏ธ No changes to commit"
            return 0
          fi
        }
        
        # === ุดุฑูุน: ูพุงฺฉ ฺฉุฑุฏู ูุงูโูุง ูููุช ูุฏู ===
        cleanup_temp_files
        
        # === ุฑุงูโุญู ฑ: ุฑูุด ูุนููู ===
        show_status "๐ ุฑุงูโุญู ฑ: ุฑูุด ูุนููู..."
        git fetch origin
        
        # ุณุน ฺฉู merge ฺฉู
        if git merge origin/main --no-ff --no-edit; then
          echo "โ Merge ููููุชโุขูุฒ"
        else
          echo "โ๏ธ Merge ุจุง conflict ููุงุฌู ุดุฏุ ุงุฏุงูู ุจุง ุญุงูุช ูุนู"
          git merge --abort 2>/dev/null || true
        fi
        
        # ุงุฌุฑุง ุงุณฺฉุฑูพุช (ุง ุงุณุชูุงุฏู ุงุฒ ฺฉุด)
        if run_update_and_save; then
          if commit_and_push; then
            echo "๐ ุฑุงูโุญู ฑ ูููู ุจูุฏ!"
            cleanup_temp_files  # ูพุงฺฉ ฺฉุฑุฏู ูุงู ูููุช ุจุนุฏ ุงุฒ ููููุช
            exit 0
          fi
        fi
        
        # === ุฑุงูโุญู ฒ: rebase ===
        show_status "๐ ุฑุงูโุญู ฒ: ุชูุงุด ุจุง rebase..."
        git fetch origin
        
        # reset ุจู origin/main
        git reset --hard origin/main 2>/dev/null || true
        
        # ุงุฌุฑุง ุฏูุจุงุฑู ุงุณฺฉุฑูพุช (ุง ุงุณุชูุงุฏู ุงุฒ ฺฉุด)
        if run_update_and_save; then
          # ุจุง --force push ฺฉู
          git add -f output/ 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            git commit -m "๐ค Update proxy list - $COMMIT_DATE"
            
            if git push origin HEAD:main --force-with-lease; then
              echo "โ ุฑุงูโุญู ฒ ุจุง force ูููู ุจูุฏ!"
              cleanup_temp_files  # ูพุงฺฉ ฺฉุฑุฏู ูุงู ูููุช
              exit 0
            fi
          fi
        fi
        
        # === ุฑุงูโุญู ณ: ูพุงฺฉ ฺฉุฑุฏู ู ุณุงุฎุช ุฌุฏุฏ ===
        show_status "๐ ุฑุงูโุญู ณ: ูพุงฺฉ ฺฉุฑุฏู ู ุณุงุฎุช ุงุฒ ูู (ุขุฎุฑู ุฑุงูโุญู)..."
        
        # ฑ. ฺฉุงููุงู ูพุงฺฉ ฺฉู ู ุงุฒ ูู ุจฺฏุฑ
        git fetch origin
        git reset --hard origin/main
        git clean -fd -x  # ุจุง -x ูุงูโูุง ignore ุดุฏู ูู ูพุงฺฉ ูโุดููุฏ
        
        # ฒ. ูพูุดู output ุฑุง ูพุงฺฉ ฺฉู
        rm -rf output/ 2>/dev/null || true
        mkdir -p output/logs
        
        # ณ. ุงุณุชูุงุฏู ุงุฒ ูุชุงุฌ ฺฉุด (ุงฺฏุฑ ูุฌูุฏ ุฏุงุฑุฏ)
        if [ -f "$TEMP_RESULTS" ] && [ -s "$TEMP_RESULTS" ]; then
          show_status "๐ ุงุณุชูุงุฏู ุงุฒ ูุชุงุฌ ุฐุฎุฑู ุดุฏู (ูุฑุญูู ุขุฎุฑ)..."
          
          python -c "
import json, yaml, os, datetime
with open('$TEMP_RESULTS', 'r') as f:
    data = json.load(f)

config = {'proxies': data['proxies'], 'metadata': data['metadata']}

os.makedirs('output', exist_ok=True)
with open('output/config.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

# ุขูพุฏุช metadata
config['metadata']['last_updated'] = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
config['metadata']['source'] = 'cached_results'

with open('output/config.yaml', 'w', encoding='utf-8') as f:
    yaml.dump(config, f, default_flow_style=False, allow_unicode=True)

print(f'โ ูุชุงุฌ ุงุฒ ฺฉุด ุจุงุฑฺฏุฐุงุฑ ุดุฏ ({len(data[\"proxies\"])} ูพุฑูฺฉุณ)')
          "
        else
          # ด. ุงฺฏุฑ ฺฉุด ูุฌูุฏ ูุฏุงุฑุฏุ ุงุณฺฉุฑูพุช ุฑุง ุงุฌุฑุง ฺฉู
          show_status "๐ ุงุณุชุฎุฑุงุฌ ูพุฑูฺฉุณโูุง (ุงุฌุฑุง ุฌุฏุฏ)..."
          python scripts/update.py
        fi
        
        # ต. ุจุฑุฑุณ ูุงู config
        if [ ! -f "output/config.yaml" ]; then
          echo "โ ูุงู config ุณุงุฎุชู ูุดุฏ!"
          cleanup_temp_files
          exit 1
        fi
        
        # ถ. ุงุถุงูู ฺฉุฑุฏู ู commit
        git add output/
        COMMIT_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
        git commit -m "๐ค Update proxy list - $COMMIT_DATE"
        
        # ท. push ุจุง force ูุทูู
        if git push origin HEAD:main --force; then
          echo "โ ุฑุงูโุญู ณ (ุขุฎุฑู ุฑุงูโุญู) ูููู ุจูุฏ!"
          
          # ููุงุด ุงุทูุงุนุงุช
          if [ -f "output/config.yaml" ]; then
            echo "๐ ุงุทูุงุนุงุช ููุง:"
            python -c "
import yaml, os
with open('output/config.yaml', 'r', encoding='utf-8') as f:
    config = yaml.safe_load(f)
proxies = config.get('proxies', [])
active = sum(1 for p in proxies if p.get('is_active', False))
print(f'   โข ฺฉู ูพุฑูฺฉุณโูุง: {len(proxies)}')
print(f'   โข ูพุฑูฺฉุณโูุง ูุนุงู: {active}')
            "
          fi
          
          cleanup_temp_files  # ูพุงฺฉ ฺฉุฑุฏู ูุงู ูููุช ุจุนุฏ ุงุฒ ููููุช
          exit 0
        else
          echo "โ ุญุช ุขุฎุฑู ุฑุงูโุญู ูู ุฌูุงุจ ูุฏุงุฏ!"
          cleanup_temp_files
          exit 1
        fi
    
    # ูพุงฺฉ ฺฉุฑุฏู ูุงูโูุง ูููุช ุฏุฑ ุตูุฑุช ูุฑฺฏููู ุฎุทุง (ุจู ุนููุงู fallback)
    - name: ๐งน ูพุงฺฉุณุงุฒ ููุง ูุงูโูุง ูููุช
      if: always()
      run: |
        rm -f temp_proxy_results.json temp_lock.file 2>/dev/null || true
        echo "โ ูุงูโูุง ูููุช ูพุงฺฉ ุดุฏูุฏ"
